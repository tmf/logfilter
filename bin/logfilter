#!/usr/bin/env php
<?php
/**
 * @autor     Tom Forrer <tom.forrer@gmail.com>
 * @copyright Copyright (c) 2015 Tom Forrer (http://github.com/tmf)
 */

date_default_timezone_set('UTC');

set_time_limit(0);

(@include_once __DIR__ . '/../vendor/autoload.php') || @include_once __DIR__ . '/../../../autoload.php';

use Symfony\Component\DependencyInjection\ContainerBuilder,
    Symfony\Component\DependencyInjection\Loader\YamlFileLoader,
    Symfony\Component\Config\FileLocator,
    Symfony\Component\EventDispatcher\DependencyInjection\RegisterListenersPass;

use Tmf\LogFilter\LogEntryProducer;

$container = new ContainerBuilder();
$baseDir = realpath(__DIR__ . DIRECTORY_SEPARATOR . '..');

$loader = new YamlFileLoader($container, new FileLocator($baseDir));
$loader->load('config.yml');
$container->addCompilerPass(new RegisterListenersPass());
$container->compile();

/**
 * @var LogEntryProducer $logEntryProducer
 */
$logEntryProducer = $container->get('tmf.logfilter.reader');
$logEntryProducer->process($baseDir . DIRECTORY_SEPARATOR . 'access.log');